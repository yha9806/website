# WenXin MoYun - Structured Logging Configuration
# Configuration for Google Cloud Logging with structured log analysis

# Log Routing Configuration
logRouting:
  # Route application logs to separate sink
  - name: "app-logs-sink"
    description: "Application logs for analysis and debugging"
    destination: "bigquery.googleapis.com/projects/wenxin-moyun-prod/datasets/app_logs"
    filter: |
      resource.type="cloud_run_revision"
      AND resource.labels.service_name="wenxin-moyun-api"
      AND severity>=INFO
    uniqueWriterIdentity: true
    
  # Route error logs to dedicated sink
  - name: "error-logs-sink"
    description: "Error logs for immediate attention"
    destination: "bigquery.googleapis.com/projects/wenxin-moyun-prod/datasets/error_logs"
    filter: |
      resource.type="cloud_run_revision"
      AND resource.labels.service_name="wenxin-moyun-api"
      AND severity>=ERROR
    uniqueWriterIdentity: true
    
  # Route audit logs for security monitoring
  - name: "audit-logs-sink"
    description: "Security and access audit logs"
    destination: "storage.googleapis.com/wenxin-moyun-prod-audit-logs"
    filter: |
      protoPayload.@type="type.googleapis.com/google.cloud.audit.AuditLog"
      AND protoPayload.serviceName="run.googleapis.com"
    uniqueWriterIdentity: true

# Structured Logging Schema
logStructure:
  # Application Event Log Format
  applicationLogs:
    fields:
      - name: "timestamp"
        type: "TIMESTAMP"
        description: "Event timestamp in UTC"
        required: true
        
      - name: "severity"
        type: "STRING"
        description: "Log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)"
        required: true
        
      - name: "service"
        type: "STRING"
        description: "Service name (api, frontend, worker)"
        required: true
        
      - name: "module"
        type: "STRING"
        description: "Application module or component"
        required: true
        
      - name: "message"
        type: "STRING"
        description: "Human-readable log message"
        required: true
        
      - name: "user_id"
        type: "STRING"
        description: "User ID for authenticated requests"
        required: false
        
      - name: "session_id"
        type: "STRING"
        description: "Session identifier for tracking"
        required: false
        
      - name: "request_id"
        type: "STRING"
        description: "Unique request identifier for tracing"
        required: false
        
      - name: "endpoint"
        type: "STRING"
        description: "API endpoint or page route"
        required: false
        
      - name: "method"
        type: "STRING"
        description: "HTTP method (GET, POST, etc.)"
        required: false
        
      - name: "status_code"
        type: "INTEGER"
        description: "HTTP response status code"
        required: false
        
      - name: "response_time"
        type: "FLOAT"
        description: "Request processing time in milliseconds"
        required: false
        
      - name: "ai_model"
        type: "STRING"
        description: "AI model used for processing"
        required: false
        
      - name: "evaluation_id"
        type: "STRING"
        description: "Evaluation task identifier"
        required: false
        
      - name: "error_code"
        type: "STRING"
        description: "Application-specific error code"
        required: false
        
      - name: "error_details"
        type: "JSON"
        description: "Additional error context and stack trace"
        required: false
        
      - name: "metadata"
        type: "JSON"
        description: "Additional contextual information"
        required: false

  # Performance Metrics Log Format
  performanceLogs:
    fields:
      - name: "timestamp"
        type: "TIMESTAMP"
        description: "Metric collection timestamp"
        required: true
        
      - name: "metric_name"
        type: "STRING"
        description: "Performance metric identifier"
        required: true
        
      - name: "metric_value"
        type: "FLOAT"
        description: "Metric value"
        required: true
        
      - name: "unit"
        type: "STRING"
        description: "Metric unit (ms, mb, percent, count)"
        required: true
        
      - name: "service"
        type: "STRING"
        description: "Service generating the metric"
        required: true
        
      - name: "labels"
        type: "JSON"
        description: "Metric dimensions and tags"
        required: false

  # Security Event Log Format
  securityLogs:
    fields:
      - name: "timestamp"
        type: "TIMESTAMP"
        description: "Security event timestamp"
        required: true
        
      - name: "event_type"
        type: "STRING"
        description: "Security event category"
        required: true
        
      - name: "severity"
        type: "STRING"
        description: "Security event severity"
        required: true
        
      - name: "source_ip"
        type: "STRING"
        description: "Client IP address"
        required: false
        
      - name: "user_agent"
        type: "STRING"
        description: "Client user agent"
        required: false
        
      - name: "user_id"
        type: "STRING"
        description: "Associated user ID"
        required: false
        
      - name: "action"
        type: "STRING"
        description: "Action attempted or performed"
        required: true
        
      - name: "resource"
        type: "STRING"
        description: "Target resource or endpoint"
        required: false
        
      - name: "result"
        type: "STRING"
        description: "Action result (success, failure, blocked)"
        required: true
        
      - name: "details"
        type: "JSON"
        description: "Additional security context"
        required: false

# Log Retention Policies
retentionPolicies:
  # Application logs - 90 days
  - name: "application-logs-retention"
    filter: |
      resource.type="cloud_run_revision"
      AND resource.labels.service_name="wenxin-moyun-api"
      AND severity>=INFO
      AND severity<ERROR
    retentionDays: 90
    
  # Error logs - 180 days (longer for debugging)
  - name: "error-logs-retention"
    filter: |
      resource.type="cloud_run_revision"
      AND resource.labels.service_name="wenxin-moyun-api"
      AND severity>=ERROR
    retentionDays: 180
    
  # Audit logs - 365 days (compliance requirement)
  - name: "audit-logs-retention"
    filter: |
      protoPayload.@type="type.googleapis.com/google.cloud.audit.AuditLog"
    retentionDays: 365
    
  # Performance logs - 30 days (high volume, short retention)
  - name: "performance-logs-retention"
    filter: |
      jsonPayload.metric_name != ""
    retentionDays: 30

# Log Export Configuration for Analytics
logExports:
  # Daily aggregated metrics export
  - name: "daily-metrics-export"
    destination: "bigquery.googleapis.com/projects/wenxin-moyun-prod/datasets/analytics"
    filter: |
      resource.type="cloud_run_revision"
      AND jsonPayload.metric_name != ""
    schedule: "0 2 * * *"  # Daily at 2 AM UTC
    
  # Weekly error analysis export
  - name: "weekly-errors-export"
    destination: "storage.googleapis.com/wenxin-moyun-prod-analysis"
    filter: |
      severity>=ERROR
      AND timestamp >= timestamp_sub(current_timestamp(), interval 7 day)
    schedule: "0 3 * * 0"  # Weekly on Sunday at 3 AM UTC

# Custom Log-based Metrics
logBasedMetrics:
  # API Response Time Distribution
  - name: "api_response_time_distribution"
    description: "Distribution of API response times"
    filter: |
      resource.type="cloud_run_revision"
      AND resource.labels.service_name="wenxin-moyun-api"
      AND jsonPayload.response_time > 0
    valueExtractor: "jsonPayload.response_time"
    metricDescriptor:
      unit: "ms"
      valueType: "DISTRIBUTION"
      metricKind: "GAUGE"
    bucketOptions:
      exponentialBuckets:
        numFiniteBuckets: 20
        growthFactor: 2
        scale: 1
        
  # User Activity Counter
  - name: "user_activity_count"
    description: "Count of user activities by type"
    filter: |
      resource.type="cloud_run_revision"
      AND jsonPayload.user_id != ""
      AND jsonPayload.endpoint != ""
    labelExtractors:
      activity_type: "jsonPayload.endpoint"
      user_type: 'if(jsonPayload.user_id = "guest", "guest", "authenticated")'
    metricDescriptor:
      unit: "1"
      valueType: "INT64"
      metricKind: "COUNTER"
      
  # AI Model Usage Statistics
  - name: "ai_model_usage_stats"
    description: "AI model usage and success rates"
    filter: |
      resource.type="cloud_run_revision"
      AND jsonPayload.ai_model != ""
    labelExtractors:
      model_name: "jsonPayload.ai_model"
      status: "if(jsonPayload.error_code = null, 'success', 'error')"
    metricDescriptor:
      unit: "1"
      valueType: "INT64"
      metricKind: "COUNTER"
      
  # Evaluation Processing Time
  - name: "evaluation_processing_time"
    description: "Time taken to process AI evaluations"
    filter: |
      resource.type="cloud_run_revision"
      AND jsonPayload.evaluation_id != ""
      AND jsonPayload.response_time > 0
    valueExtractor: "jsonPayload.response_time"
    labelExtractors:
      ai_model: "jsonPayload.ai_model"
    metricDescriptor:
      unit: "ms"
      valueType: "DOUBLE"
      metricKind: "GAUGE"

# Log Sampling Configuration
samplingConfig:
  # High-volume endpoints - sample at 1%
  - name: "high-volume-sampling"
    filter: |
      resource.type="cloud_run_revision"
      AND jsonPayload.endpoint IN ("/health", "/api/v1/models", "/api/v1/battles/random")
      AND severity<=INFO
    sampleRate: 0.01
    
  # Error logs - never sample (keep all)
  - name: "error-no-sampling"
    filter: |
      severity>=ERROR
    sampleRate: 1.0
    
  # Authentication events - always keep
  - name: "auth-no-sampling"
    filter: |
      jsonPayload.endpoint CONTAINS "auth"
      OR jsonPayload.endpoint CONTAINS "login"
    sampleRate: 1.0

# Alert Integration
alertIntegration:
  # Log-based alert conditions
  conditions:
    - name: "high_error_rate_from_logs"
      description: "Error rate exceeds threshold based on log analysis"
      logFilter: |
        resource.type="cloud_run_revision"
        AND severity>=ERROR
      threshold: 10  # errors per minute
      duration: "300s"
      
    - name: "ai_model_timeout_spike"
      description: "Spike in AI model timeout errors"
      logFilter: |
        jsonPayload.error_code="ai_model_timeout"
      threshold: 5  # timeouts per 5 minutes
      duration: "300s"
      
    - name: "authentication_failures"
      description: "High number of authentication failures"
      logFilter: |
        jsonPayload.endpoint CONTAINS "auth"
        AND jsonPayload.result="failure"
      threshold: 20  # failed attempts per 10 minutes
      duration: "600s"

# Log Analysis Queries (for BigQuery)
analysisQueries:
  # Top errors by frequency
  topErrors: |
    SELECT
      jsonPayload.error_code,
      jsonPayload.module,
      COUNT(*) as error_count,
      STRING_AGG(DISTINCT jsonPayload.message LIMIT 3) as sample_messages
    FROM `wenxin-moyun-prod.app_logs.*`
    WHERE 
      _TABLE_SUFFIX BETWEEN FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY))
      AND FORMAT_DATE('%Y%m%d', CURRENT_DATE())
      AND severity = 'ERROR'
    GROUP BY jsonPayload.error_code, jsonPayload.module
    ORDER BY error_count DESC
    LIMIT 20
    
  # API performance trends
  performanceTrends: |
    SELECT
      DATE(timestamp) as date,
      jsonPayload.endpoint,
      PERCENTILE_CONT(CAST(jsonPayload.response_time AS FLOAT64), 0.5) OVER (
        PARTITION BY DATE(timestamp), jsonPayload.endpoint
      ) as median_response_time,
      PERCENTILE_CONT(CAST(jsonPayload.response_time AS FLOAT64), 0.95) OVER (
        PARTITION BY DATE(timestamp), jsonPayload.endpoint
      ) as p95_response_time,
      COUNT(*) as request_count
    FROM `wenxin-moyun-prod.app_logs.*`
    WHERE 
      _TABLE_SUFFIX BETWEEN FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY))
      AND FORMAT_DATE('%Y%m%d', CURRENT_DATE())
      AND jsonPayload.response_time IS NOT NULL
    GROUP BY date, jsonPayload.endpoint
    ORDER BY date DESC, request_count DESC
    
  # User behavior analysis
  userBehavior: |
    SELECT
      EXTRACT(HOUR FROM timestamp) as hour_of_day,
      CASE 
        WHEN jsonPayload.user_id = 'guest' THEN 'guest'
        ELSE 'authenticated'
      END as user_type,
      jsonPayload.endpoint,
      COUNT(*) as activity_count,
      COUNT(DISTINCT jsonPayload.session_id) as unique_sessions
    FROM `wenxin-moyun-prod.app_logs.*`
    WHERE 
      _TABLE_SUFFIX BETWEEN FORMAT_DATE('%Y%m%d', DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY))
      AND FORMAT_DATE('%Y%m%d', CURRENT_DATE())
      AND jsonPayload.endpoint IS NOT NULL
    GROUP BY hour_of_day, user_type, jsonPayload.endpoint
    ORDER BY hour_of_day, activity_count DESC