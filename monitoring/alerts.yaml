# WenXin MoYun - Google Cloud Monitoring Alerts Configuration
# This file defines alerts for production monitoring

displayName: "WenXin MoYun Production Alerts"
documentation:
  content: "Monitoring alerts for WenXin MoYun AI art evaluation platform"
  mimeType: "text/markdown"

policies:
  # Backend API Health Monitoring
  - displayName: "Backend API Down"
    documentation:
      content: "Backend API service is not responding to health checks"
      mimeType: "text/plain"
    conditions:
      - displayName: "API Health Check Failure"
        conditionThreshold:
          filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="wenxin-moyun-api"'
          comparison: COMPARISON_LESS_THAN
          thresholdValue: 1
          duration: 300s
          aggregations:
            - alignmentPeriod: 60s
              perSeriesAligner: ALIGN_RATE
              crossSeriesReducer: REDUCE_MEAN
              groupByFields: ["resource.label.service_name"]
    alertStrategy:
      autoClose: 1800s
    severity: CRITICAL
    
  # High Error Rate Alert
  - displayName: "High Error Rate"
    documentation:
      content: "Backend API error rate exceeds 5% threshold"
      mimeType: "text/plain"
    conditions:
      - displayName: "API Error Rate > 5%"
        conditionThreshold:
          filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="wenxin-moyun-api"'
          comparison: COMPARISON_GREATER_THAN
          thresholdValue: 0.05
          duration: 300s
          aggregations:
            - alignmentPeriod: 60s
              perSeriesAligner: ALIGN_RATE
              crossSeriesReducer: REDUCE_MEAN
              groupByFields: ["resource.label.service_name"]
    alertStrategy:
      autoClose: 1800s
    severity: WARNING

  # High Response Time Alert
  - displayName: "High Response Time"
    documentation:
      content: "Backend API response time exceeds 2 seconds"
      mimeType: "text/plain"
    conditions:
      - displayName: "API Response Time > 2s"
        conditionThreshold:
          filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="wenxin-moyun-api"'
          comparison: COMPARISON_GREATER_THAN
          thresholdValue: 2000
          duration: 300s
          aggregations:
            - alignmentPeriod: 60s
              perSeriesAligner: ALIGN_MEAN
              crossSeriesReducer: REDUCE_MEAN
              groupByFields: ["resource.label.service_name"]
    alertStrategy:
      autoClose: 1800s
    severity: WARNING

  # Database Connection Issues
  - displayName: "Database Connection Errors"
    documentation:
      content: "High number of database connection errors detected"
      mimeType: "text/plain"
    conditions:
      - displayName: "DB Connection Errors"
        conditionThreshold:
          filter: 'resource.type="cloudsql_database" AND resource.labels.database_id="wenxin-moyun-prod:wenxin-postgres"'
          comparison: COMPARISON_GREATER_THAN
          thresholdValue: 10
          duration: 300s
          aggregations:
            - alignmentPeriod: 60s
              perSeriesAligner: ALIGN_RATE
              crossSeriesReducer: REDUCE_SUM
    alertStrategy:
      autoClose: 1800s
    severity: CRITICAL

  # High CPU Usage Alert
  - displayName: "High CPU Usage"
    documentation:
      content: "Cloud Run service CPU utilization exceeds 80%"
      mimeType: "text/plain"
    conditions:
      - displayName: "CPU Usage > 80%"
        conditionThreshold:
          filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="wenxin-moyun-api"'
          comparison: COMPARISON_GREATER_THAN
          thresholdValue: 0.8
          duration: 600s
          aggregations:
            - alignmentPeriod: 60s
              perSeriesAligner: ALIGN_MEAN
              crossSeriesReducer: REDUCE_MEAN
              groupByFields: ["resource.label.service_name"]
    alertStrategy:
      autoClose: 1800s
    severity: WARNING

  # High Memory Usage Alert
  - displayName: "High Memory Usage"
    documentation:
      content: "Cloud Run service memory utilization exceeds 85%"
      mimeType: "text/plain"
    conditions:
      - displayName: "Memory Usage > 85%"
        conditionThreshold:
          filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="wenxin-moyun-api"'
          comparison: COMPARISON_GREATER_THAN
          thresholdValue: 0.85
          duration: 600s
          aggregations:
            - alignmentPeriod: 60s
              perSeriesAligner: ALIGN_MEAN
              crossSeriesReducer: REDUCE_MEAN
              groupByFields: ["resource.label.service_name"]
    alertStrategy:
      autoClose: 1800s
    severity: WARNING

  # Database Storage Usage Alert
  - displayName: "Database Storage Usage High"
    documentation:
      content: "Cloud SQL database storage utilization exceeds 85%"
      mimeType: "text/plain"
    conditions:
      - displayName: "DB Storage > 85%"
        conditionThreshold:
          filter: 'resource.type="cloudsql_database" AND resource.labels.database_id="wenxin-moyun-prod:wenxin-postgres"'
          comparison: COMPARISON_GREATER_THAN
          thresholdValue: 0.85
          duration: 300s
          aggregations:
            - alignmentPeriod: 300s
              perSeriesAligner: ALIGN_MEAN
              crossSeriesReducer: REDUCE_MEAN
    alertStrategy:
      autoClose: 3600s
    severity: WARNING

# Notification Channels Configuration
notificationChannels:
  # Email notifications
  - type: "email"
    displayName: "Admin Email Alerts"
    labels:
      email_address: "admin@wenxin-moyun.com"
    description: "Primary email notifications for critical alerts"
    
  # Slack notifications (optional)
  # - type: "slack"
  #   displayName: "Dev Team Slack"
  #   labels:
  #     channel_name: "#alerts"
  #     url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
  #   description: "Slack notifications for development team"

# Alert Routing
alertPolicyRouting:
  CRITICAL:
    - "Admin Email Alerts"
    # - "Dev Team Slack"
  WARNING:
    - "Admin Email Alerts"
  INFO:
    - "Admin Email Alerts"

# Custom Metrics for Application-Specific Monitoring
customMetrics:
  # AI Model Evaluation Success Rate
  - name: "ai_model_evaluation_success_rate"
    displayName: "AI Model Evaluation Success Rate"
    description: "Percentage of successful AI model evaluations"
    unit: "1"
    valueType: "DOUBLE"
    metricKind: "GAUGE"
    
  # Battle Vote Processing Time
  - name: "battle_vote_processing_time"
    displayName: "Battle Vote Processing Time"
    description: "Average time to process battle votes"
    unit: "ms"
    valueType: "DOUBLE"
    metricKind: "GAUGE"
    
  # Active User Sessions
  - name: "active_user_sessions"
    displayName: "Active User Sessions"
    description: "Number of currently active user sessions"
    unit: "1"
    valueType: "INT64"
    metricKind: "GAUGE"

# Dashboard Configuration
dashboards:
  - displayName: "WenXin MoYun Production Dashboard"
    widgets:
      - title: "API Request Rate"
        scorecard:
          timeSeriesQuery:
            filter: 'resource.type="cloud_run_revision"'
            aggregation:
              alignmentPeriod: 60s
              perSeriesAligner: ALIGN_RATE
              
      - title: "Error Rate"
        scorecard:
          timeSeriesQuery:
            filter: 'resource.type="cloud_run_revision"'
            aggregation:
              alignmentPeriod: 60s
              perSeriesAligner: ALIGN_RATE
              
      - title: "Response Time"
        xyChart:
          timeSeries:
            - filter: 'resource.type="cloud_run_revision"'
              aggregation:
                alignmentPeriod: 60s
                perSeriesAligner: ALIGN_MEAN
                
      - title: "CPU Utilization"
        xyChart:
          timeSeries:
            - filter: 'resource.type="cloud_run_revision"'
              aggregation:
                alignmentPeriod: 60s
                perSeriesAligner: ALIGN_MEAN
                
      - title: "Memory Utilization"
        xyChart:
          timeSeries:
            - filter: 'resource.type="cloud_run_revision"'
              aggregation:
                alignmentPeriod: 60s
                perSeriesAligner: ALIGN_MEAN

# Log-based Metrics
logBasedMetrics:
  - name: "error_log_count"
    description: "Count of error logs from application"
    filter: 'resource.type="cloud_run_revision" AND severity>=ERROR'
    metricDescriptor:
      unit: "1"
      valueType: "INT64"
      metricKind: "COUNTER"
      
  - name: "ai_model_timeout_count"
    description: "Count of AI model timeout errors"
    filter: 'resource.type="cloud_run_revision" AND textPayload:"timeout" AND textPayload:"ai_model"'
    metricDescriptor:
      unit: "1"
      valueType: "INT64"
      metricKind: "COUNTER"

# SLO (Service Level Objectives) Configuration
slos:
  - displayName: "API Availability SLO"
    serviceLevelIndicator:
      requestBased:
        distributionCut:
          range:
            max: 500  # 500ms response time threshold
    goal: 0.99  # 99% availability
    period: 2592000s  # 30 days
    
  - displayName: "API Error Rate SLO"
    serviceLevelIndicator:
      requestBased:
        goodTotalRatio:
          badServiceFilter: 'resource.type="cloud_run_revision" AND response_code>=400'
          totalServiceFilter: 'resource.type="cloud_run_revision"'
    goal: 0.95  # 95% success rate
    period: 2592000s  # 30 days