{
  "$schema": "https://cloud.google.com/monitoring/docs/alert-policies",
  "description": "VULCA Platform Alert Policies for GCP Cloud Monitoring",
  "version": "1.0.0",
  "project": "wenxin-moyun-prod-new",
  "alertPolicies": [
    {
      "displayName": "VULCA API - High Error Rate",
      "documentation": {
        "content": "API error rate exceeds 5% over 5 minutes. Check Cloud Run logs for details.",
        "mimeType": "text/markdown"
      },
      "conditions": [
        {
          "displayName": "Error rate > 5%",
          "conditionThreshold": {
            "filter": "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"wenxin-moyun-api\" AND metric.type=\"run.googleapis.com/request_count\" AND metric.labels.response_code_class=\"5xx\"",
            "comparison": "COMPARISON_GT",
            "thresholdValue": 0.05,
            "duration": "300s",
            "aggregations": [
              {
                "alignmentPeriod": "60s",
                "perSeriesAligner": "ALIGN_RATE"
              }
            ]
          }
        }
      ],
      "combiner": "OR",
      "notificationChannels": ["projects/wenxin-moyun-prod-new/notificationChannels/EMAIL"],
      "severity": "ERROR"
    },
    {
      "displayName": "VULCA API - High Latency",
      "documentation": {
        "content": "API p99 latency exceeds 5 seconds. May indicate performance degradation.",
        "mimeType": "text/markdown"
      },
      "conditions": [
        {
          "displayName": "P99 Latency > 5s",
          "conditionThreshold": {
            "filter": "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"wenxin-moyun-api\" AND metric.type=\"run.googleapis.com/request_latencies\"",
            "comparison": "COMPARISON_GT",
            "thresholdValue": 5000,
            "duration": "300s",
            "aggregations": [
              {
                "alignmentPeriod": "60s",
                "perSeriesAligner": "ALIGN_PERCENTILE_99"
              }
            ]
          }
        }
      ],
      "combiner": "OR",
      "notificationChannels": ["projects/wenxin-moyun-prod-new/notificationChannels/EMAIL"],
      "severity": "WARNING"
    },
    {
      "displayName": "VULCA API - Instance Scaling",
      "documentation": {
        "content": "Cloud Run instances scaled beyond normal range. May indicate traffic spike or resource leak.",
        "mimeType": "text/markdown"
      },
      "conditions": [
        {
          "displayName": "Instance count > 10",
          "conditionThreshold": {
            "filter": "resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"wenxin-moyun-api\" AND metric.type=\"run.googleapis.com/container/instance_count\"",
            "comparison": "COMPARISON_GT",
            "thresholdValue": 10,
            "duration": "300s",
            "aggregations": [
              {
                "alignmentPeriod": "60s",
                "perSeriesAligner": "ALIGN_MAX"
              }
            ]
          }
        }
      ],
      "combiner": "OR",
      "notificationChannels": ["projects/wenxin-moyun-prod-new/notificationChannels/EMAIL"],
      "severity": "WARNING"
    },
    {
      "displayName": "VULCA Database - Connection Issues",
      "documentation": {
        "content": "Cloud SQL connection failures detected. Check database health and connection pool.",
        "mimeType": "text/markdown"
      },
      "conditions": [
        {
          "displayName": "Connection failures > 5/min",
          "conditionThreshold": {
            "filter": "resource.type=\"cloudsql_database\" AND resource.labels.database_id=\"wenxin-moyun-prod-new:asia-east1:wenxin-postgres\" AND metric.type=\"cloudsql.googleapis.com/database/network/connections\"",
            "comparison": "COMPARISON_LT",
            "thresholdValue": 1,
            "duration": "300s"
          }
        }
      ],
      "combiner": "OR",
      "notificationChannels": ["projects/wenxin-moyun-prod-new/notificationChannels/EMAIL"],
      "severity": "CRITICAL"
    },
    {
      "displayName": "VULCA Storage - High Usage",
      "documentation": {
        "content": "Cloud Storage bucket usage exceeds 80%. Consider cleanup or quota increase.",
        "mimeType": "text/markdown"
      },
      "conditions": [
        {
          "displayName": "Storage > 80% of quota",
          "conditionThreshold": {
            "filter": "resource.type=\"gcs_bucket\" AND resource.labels.bucket_name=\"wenxin-moyun-prod-new-static\" AND metric.type=\"storage.googleapis.com/storage/total_bytes\"",
            "comparison": "COMPARISON_GT",
            "thresholdValue": 8589934592,
            "duration": "3600s"
          }
        }
      ],
      "combiner": "OR",
      "notificationChannels": ["projects/wenxin-moyun-prod-new/notificationChannels/EMAIL"],
      "severity": "WARNING"
    },
    {
      "displayName": "VULCA - Uptime Check Failure",
      "documentation": {
        "content": "Frontend or API endpoint is not responding. Immediate investigation required.",
        "mimeType": "text/markdown"
      },
      "conditions": [
        {
          "displayName": "Uptime check failed",
          "conditionThreshold": {
            "filter": "metric.type=\"monitoring.googleapis.com/uptime_check/check_passed\" AND resource.type=\"uptime_url\"",
            "comparison": "COMPARISON_LT",
            "thresholdValue": 1,
            "duration": "60s"
          }
        }
      ],
      "combiner": "OR",
      "notificationChannels": ["projects/wenxin-moyun-prod-new/notificationChannels/EMAIL"],
      "severity": "CRITICAL"
    }
  ],
  "uptimeChecks": [
    {
      "displayName": "VULCA Frontend Uptime",
      "monitoredResource": {
        "type": "uptime_url",
        "labels": {
          "host": "storage.googleapis.com",
          "project_id": "wenxin-moyun-prod-new"
        }
      },
      "httpCheck": {
        "path": "/wenxin-moyun-prod-new-static/index.html",
        "port": 443,
        "useSsl": true,
        "validateSsl": true,
        "acceptedResponseStatusCodes": [
          { "statusClass": "STATUS_CLASS_2XX" }
        ]
      },
      "period": "60s",
      "timeout": "10s"
    },
    {
      "displayName": "VULCA API Health Check",
      "monitoredResource": {
        "type": "uptime_url",
        "labels": {
          "host": "wenxin-moyun-api-229980166599.asia-east1.run.app",
          "project_id": "wenxin-moyun-prod-new"
        }
      },
      "httpCheck": {
        "path": "/api/health",
        "port": 443,
        "useSsl": true,
        "validateSsl": true,
        "acceptedResponseStatusCodes": [
          { "statusClass": "STATUS_CLASS_2XX" }
        ]
      },
      "period": "60s",
      "timeout": "10s"
    }
  ],
  "deploymentInstructions": {
    "createNotificationChannel": "gcloud alpha monitoring channels create --channel-content-from-file=notification-channel.json",
    "createAlertPolicies": "gcloud alpha monitoring policies create --policy-from-file=gcp-alerts.json",
    "createUptimeChecks": "gcloud monitoring uptime-check-configs create --config-from-file=uptime-check.json"
  }
}
